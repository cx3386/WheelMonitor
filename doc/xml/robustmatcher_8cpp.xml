<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.8.14">
  <compounddef id="robustmatcher_8cpp" kind="file" language="C++">
    <compoundname>robustmatcher.cpp</compoundname>
    <includes refid="stdafx_8h" local="yes">stdafx.h</includes>
    <includes refid="robustmatcher_8h" local="yes">robustmatcher.h</includes>
    <incdepgraph>
      <node id="650">
        <label>sources/robustmatcher.cpp</label>
        <link refid="robustmatcher_8cpp"/>
        <childnode refid="651" relation="include">
        </childnode>
        <childnode refid="653" relation="include">
        </childnode>
      </node>
      <node id="654">
        <label>opencv.hpp</label>
      </node>
      <node id="653">
        <label>robustmatcher.h</label>
        <link refid="robustmatcher_8h"/>
        <childnode refid="654" relation="include">
        </childnode>
      </node>
      <node id="652">
        <label>QtWidgets</label>
      </node>
      <node id="651">
        <label>stdafx.h</label>
        <link refid="stdafx_8h"/>
        <childnode refid="652" relation="include">
        </childnode>
      </node>
    </incdepgraph>
      <sectiondef kind="define">
      <memberdef kind="define" id="robustmatcher_8cpp_1ae71449b1cc6e6250b91f539153a7a0d3" prot="public" static="no">
        <name>M_PI</name>
        <initializer>(3.14159265358979323846)</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="sources/robustmatcher.cpp" line="6" column="9" bodyfile="sources/robustmatcher.cpp" bodystart="6" bodyend="-1"/>
      </memberdef>
      </sectiondef>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="preprocessor">#include<sp/>&quot;<ref refid="stdafx_8h" kindref="compound">stdafx.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2"><highlight class="normal"></highlight></codeline>
<codeline lineno="3"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="robustmatcher_8h" kindref="compound">robustmatcher.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4"><highlight class="normal"></highlight><highlight class="comment">//#include<sp/>&lt;qmath.h&gt;<sp/>//use<sp/>M_PI</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5"><highlight class="normal"></highlight><highlight class="preprocessor">#ifndef<sp/>M_PI</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6" refid="robustmatcher_8cpp_1ae71449b1cc6e6250b91f539153a7a0d3" refkind="member"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>M_PI<sp/>(3.14159265358979323846)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="7"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="8"><highlight class="normal"></highlight></codeline>
<codeline lineno="9"><highlight class="normal"></highlight><highlight class="keyword">using<sp/>namespace<sp/></highlight><highlight class="normal"><ref refid="namespacestd" kindref="compound">std</ref>;</highlight></codeline>
<codeline lineno="10"><highlight class="normal"></highlight><highlight class="keyword">using<sp/>namespace<sp/></highlight><highlight class="normal"><ref refid="namespacecv" kindref="compound">cv</ref>;</highlight></codeline>
<codeline lineno="11"><highlight class="normal"></highlight></codeline>
<codeline lineno="12" refid="class_robust_matcher_1a78641d08f99564cdf67a7a3f8d544f71" refkind="member"><highlight class="normal"><ref refid="class_robust_matcher_1a78641d08f99564cdf67a7a3f8d544f71" kindref="member">RobustMatcher::RobustMatcher</ref>()</highlight></codeline>
<codeline lineno="13"><highlight class="normal">{</highlight></codeline>
<codeline lineno="14"><highlight class="normal">}</highlight></codeline>
<codeline lineno="15"><highlight class="normal"></highlight></codeline>
<codeline lineno="16" refid="class_robust_matcher_1ae8831ade1c296513fcad9764a05d3328" refkind="member"><highlight class="normal"><ref refid="class_robust_matcher_1ae8831ade1c296513fcad9764a05d3328" kindref="member">RobustMatcher::~RobustMatcher</ref>()</highlight></codeline>
<codeline lineno="17"><highlight class="normal">{</highlight></codeline>
<codeline lineno="18"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>A<sp/>Ptr&lt;T&gt;<sp/>pretends<sp/>to<sp/>be<sp/>a<sp/>pointer<sp/>to<sp/>an<sp/>object<sp/>of<sp/>type<sp/>T.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="19"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>object<sp/>will<sp/>be<sp/>automatically<sp/>cleaned<sp/>up<sp/>once<sp/>all<sp/>Ptr<sp/>instances<sp/>pointing<sp/>to<sp/>it<sp/>are<sp/>destroyed.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="20"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>SO<sp/>there<sp/>is<sp/>no<sp/>need<sp/>to<sp/>call<sp/>delete<sp/>detector<sp/>and<sp/>matcher.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="21"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>\see<sp/>std::shared_ptr<sp/>since<sp/>C++11</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="22"><highlight class="normal">}</highlight></codeline>
<codeline lineno="23"><highlight class="normal"></highlight></codeline>
<codeline lineno="24" refid="class_robust_matcher_1a00bcb865bcc240ec0df38cecf5243f5e" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="class_robust_matcher_1a00bcb865bcc240ec0df38cecf5243f5e" kindref="member">RobustMatcher::match</ref>(cv::Mat<sp/>src1,<sp/>cv::Mat<sp/>src2,<sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>maskOuterRatio,<sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>maskInnerRatio,<sp/>cv::Mat<sp/>&amp;img_matches,<sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>&amp;angle)</highlight></codeline>
<codeline lineno="25"><highlight class="normal">{</highlight></codeline>
<codeline lineno="26"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>ro1,<sp/>ri1,<sp/>ro2,<sp/>ri2;</highlight></codeline>
<codeline lineno="27"><highlight class="normal"><sp/><sp/><sp/><sp/>Mat<sp/>mask1<sp/>=<sp/>getMask(src1.size(),<sp/>maskOuterRatio,<sp/>maskInnerRatio,<sp/>ro1,<sp/>ri1);</highlight></codeline>
<codeline lineno="28"><highlight class="normal"><sp/><sp/><sp/><sp/>Mat<sp/>mask2<sp/>=<sp/>getMask(src2.size(),<sp/>maskOuterRatio,<sp/>maskInnerRatio,<sp/>ro2,<sp/>ri2);</highlight></codeline>
<codeline lineno="29"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>detector<sp/>=<sp/>ORB::create();</highlight></codeline>
<codeline lineno="30"><highlight class="normal"><sp/><sp/><sp/><sp/>vector&lt;KeyPoint&gt;<sp/>keypoints1,<sp/>keypoints2;</highlight></codeline>
<codeline lineno="31"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>1a.<sp/>Detection<sp/>of<sp/>the<sp/>ORB<sp/>features</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="32"><highlight class="normal"><sp/><sp/><sp/><sp/>detector-&gt;detect(src1,<sp/>keypoints1,<sp/>mask1);</highlight></codeline>
<codeline lineno="33"><highlight class="normal"><sp/><sp/><sp/><sp/>detector-&gt;detect(src2,<sp/>keypoints2,<sp/>mask2);</highlight></codeline>
<codeline lineno="34"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>***********if<sp/>no<sp/>keypoint<sp/>detect<sp/>then<sp/>return</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="35"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(keypoints1.empty()<sp/>||<sp/>keypoints2.empty())</highlight></codeline>
<codeline lineno="36"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="37"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>1b.<sp/>Extraction<sp/>of<sp/>the<sp/>ORB<sp/>descriptors</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="38"><highlight class="normal"><sp/><sp/><sp/><sp/>Mat<sp/>descriptors1,<sp/>descriptors2;</highlight></codeline>
<codeline lineno="39"><highlight class="normal"><sp/><sp/><sp/><sp/>detector-&gt;compute(src1,<sp/>keypoints1,<sp/>descriptors1);</highlight></codeline>
<codeline lineno="40"><highlight class="normal"><sp/><sp/><sp/><sp/>detector-&gt;compute(src2,<sp/>keypoints2,<sp/>descriptors2);</highlight></codeline>
<codeline lineno="41"><highlight class="normal"></highlight></codeline>
<codeline lineno="42"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>2.<sp/>Match<sp/>the<sp/>two<sp/>image<sp/>descriptors</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="43"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>matcher<sp/>=<sp/>BFMatcher::create(NORM_HAMMING);</highlight></codeline>
<codeline lineno="44"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>from<sp/>image<sp/>1<sp/>to<sp/>image<sp/>2<sp/>based<sp/>on<sp/>k<sp/>nearest<sp/>neighbours<sp/>(with<sp/>k=2)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="45"><highlight class="normal"><sp/><sp/><sp/><sp/>vector&lt;vector&lt;DMatch&gt;&gt;<sp/>matches1;<sp/></highlight><highlight class="comment">//<sp/>vector<sp/>of<sp/>matches<sp/>(up<sp/>to<sp/>2<sp/>per<sp/>entry)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="46"><highlight class="normal"><sp/><sp/><sp/><sp/>matcher-&gt;knnMatch(descriptors1,<sp/>descriptors2,<sp/>matches1,<sp/>2);<sp/></highlight><highlight class="comment">//<sp/>return<sp/>2<sp/>nearest<sp/>neighbors</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="47"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>from<sp/>image<sp/>2<sp/>to<sp/>image<sp/>1<sp/>based<sp/>on<sp/>k<sp/>nearest<sp/>neighbours<sp/>(with<sp/>k=2)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="48"><highlight class="normal"><sp/><sp/><sp/><sp/>vector&lt;vector&lt;DMatch&gt;&gt;<sp/>matches2;<sp/></highlight><highlight class="comment">//<sp/>vector<sp/>of<sp/>matches<sp/>(up<sp/>to<sp/>2<sp/>per<sp/>entry)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="49"><highlight class="normal"><sp/><sp/><sp/><sp/>matcher-&gt;knnMatch(descriptors2,<sp/>descriptors1,<sp/>matches2,<sp/>2);<sp/></highlight><highlight class="comment">//<sp/>return<sp/>2<sp/>nearest<sp/>neighbors</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="50"><highlight class="normal"></highlight></codeline>
<codeline lineno="51"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>3.<sp/>Remove<sp/>matches<sp/>for<sp/>which<sp/>NN<sp/>ratio<sp/>&gt;<sp/>threshold</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="52"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>clean<sp/>image<sp/>1<sp/>-&gt;<sp/>image<sp/>2<sp/>matches</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="53"><highlight class="normal"><sp/><sp/><sp/><sp/>ratioTest(matches1);</highlight></codeline>
<codeline lineno="54"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>clean<sp/>image<sp/>2<sp/>-&gt;<sp/>image<sp/>1<sp/>matches</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="55"><highlight class="normal"><sp/><sp/><sp/><sp/>ratioTest(matches2);</highlight></codeline>
<codeline lineno="56"><highlight class="normal"></highlight></codeline>
<codeline lineno="57"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>4.<sp/>Remove<sp/>non-symmetrical<sp/>matches</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="58"><highlight class="normal"><sp/><sp/><sp/><sp/>vector&lt;DMatch&gt;<sp/>matches;</highlight></codeline>
<codeline lineno="59"><highlight class="normal"><sp/><sp/><sp/><sp/>symmetryTest(matches1,<sp/>matches2,<sp/>matches);</highlight></codeline>
<codeline lineno="60"><highlight class="normal"></highlight></codeline>
<codeline lineno="61"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>5.<sp/>判断有效匹配点对是否大于等于10个(2个就可以进行计算)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="62"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(matches.size()<sp/>&lt;<sp/>10)<sp/>{</highlight></codeline>
<codeline lineno="63"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//qDebug(&quot;the<sp/>match<sp/>point<sp/>less<sp/>than<sp/>2&quot;);</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="64"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="65"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="66"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>绘制匹配结果 <sp/>drawMatches(src1,<sp/>keypoints1,<sp/>src2,<sp/>keypoints2,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>matches,<sp/>img_matches,<sp/>Scalar::all(-1),<sp/>Scalar::all(-1),
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vector&lt;char&gt;(),<sp/>DrawMatchesFlags::NOT_DRAW_SINGLE_POINTS);
<sp/>circle(img_matches,<sp/>Point(mask1.cols<sp/>/<sp/>2,<sp/>mask1.rows<sp/>/<sp/>2),<sp/>ro1,<sp/>Scalar(0,<sp/>0,<sp/>255),<sp/>1,<sp/>LINE_AA);
<sp/><sp/><sp/><sp/>circle(img_matches,<sp/>Point(mask1.cols<sp/>/<sp/>2,<sp/>mask1.rows<sp/>/<sp/>2),<sp/>ri1,<sp/>Scalar(0,<sp/>255,<sp/>0),<sp/>1,<sp/>LINE_AA);
<sp/><sp/><sp/><sp/>circle(img_matches,<sp/>Point(mask1.cols<sp/>+<sp/>mask2.cols<sp/>/<sp/>2,<sp/>mask2.rows<sp/>/<sp/>2),<sp/>ro2,<sp/>Scalar(0,<sp/>0,<sp/>255),<sp/>1,<sp/>LINE_AA);
<sp/><sp/><sp/>circle(img_matches,<sp/>Point(mask1.cols<sp/>+<sp/>mask2.cols<sp/>/<sp/>2,<sp/>mask2.rows<sp/>/<sp/>2),<sp/>ri2,<sp/>Scalar(0,<sp/>255,<sp/>0),<sp/>1,<sp/>LINE_AA);

<sp/><sp/>//<sp/>6.<sp/>求仿射变换
<sp/><sp/><sp/>vector&lt;Point2f&gt;<sp/>obj;
<sp/><sp/><sp/>vector&lt;Point2f&gt;<sp/>scene;
<sp/>for<sp/>(int<sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>matches.size();<sp/>i++)<sp/>{
<sp/><sp/><sp/><sp/><sp/>//--<sp/>Get<sp/>the<sp/>keypoints<sp/>from<sp/>the<sp/>good<sp/>matches
<sp/><sp/><sp/><sp/><sp/><sp/><sp/>obj.push_back(keypoints1[matches[i].queryIdx].pt);
<sp/><sp/><sp/><sp/><sp/>scene.push_back(keypoints2[matches[i].trainIdx].pt);
<sp/><sp/><sp/>}
<sp/><sp/>Mat<sp/>M<sp/>=<sp/>estimateAffinePartial2D(obj,<sp/>scene);
<sp/><sp/><sp/>if<sp/>(M.data<sp/>==<sp/>nullptr)
<sp/><sp/><sp/><sp/><sp/>return<sp/>false;
<sp/><sp/>//计算旋转角度，弧度
<sp/>auto<sp/>sin_alpha<sp/>=<sp/>M.at&lt;double&gt;(1,<sp/>0);<sp/>//<sp/>sin*s
<sp/><sp/>auto<sp/>cos_alpha<sp/>=<sp/>M.at&lt;double&gt;(0,<sp/>0);<sp/>//<sp/>cos*s
<sp/><sp/>angle<sp/>=<sp/>atan(sin_alpha<sp/>/<sp/>cos_alpha);<sp/>//<sp/>cv:顺时针为正
<sp/><sp/><sp/>return<sp/>true;
}

void<sp/>RobustMatcher::symmetryTest(const<sp/>vector&lt;vector&lt;DMatch&gt;&gt;&amp;<sp/>matches1,<sp/>const<sp/>vector&lt;vector&lt;DMatch&gt;&gt;&amp;<sp/>matches2,<sp/>vector&lt;DMatch&gt;&amp;<sp/>symMatches)
{
<sp/>//<sp/>for<sp/>all<sp/>matches<sp/>image<sp/>1<sp/>-&gt;<sp/>image<sp/>2
<sp/><sp/>for<sp/>(vector&lt;vector&lt;DMatch&gt;&gt;::
<sp/><sp/><sp/><sp/><sp/><sp/>const_iterator<sp/>matchIterator1
<sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>matches1.begin();
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>matchIterator1<sp/>!=<sp/>matches1.end();<sp/>++matchIterator1)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>ignore<sp/>deleted<sp/>matches
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(matchIterator1-&gt;size()<sp/>&lt;<sp/>2)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>continue;
<sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>for<sp/>all<sp/>matches<sp/>image<sp/>2<sp/>-&gt;<sp/>image<sp/>1
<sp/><sp/><sp/><sp/><sp/><sp/>for<sp/>(vector&lt;vector&lt;DMatch&gt;&gt;::
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const_iterator<sp/>matchIterator2
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>matches2.begin();
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>matchIterator2<sp/>!=<sp/>matches2.end();
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++matchIterator2)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>ignore<sp/>deleted<sp/>matches
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(matchIterator2-&gt;size()<sp/>&lt;<sp/>2)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>continue;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>Match<sp/>symmetry<sp/>test
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>((*matchIterator1)[0].queryIdx<sp/>==<sp/>(*matchIterator2)[0].trainIdx<sp/>&amp;&amp;<sp/>(*matchIterator2)[0].queryIdx<sp/>==<sp/>(*matchIterator1)[0].trainIdx)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>add<sp/>symmetrical<sp/>match
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>symMatches.push_back(
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>DMatch((*matchIterator1)[0].queryIdx,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(*matchIterator1)[0].trainIdx,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(*matchIterator1)[0].distance));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;<sp/>//<sp/>next<sp/>match<sp/>in<sp/>image<sp/>1<sp/>-&gt;<sp/>image<sp/>2
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/>}
}

/**<sp/>\brief<sp/>kNN
<sp/>*<sp/>\param<sp/>matches<sp/>input<sp/>matches
<sp/>*<sp/>\return<sp/>the<sp/>removed<sp/>points<sp/>number
<sp/>*/
int<sp/>RobustMatcher::ratioTest(vector&lt;vector&lt;DMatch&gt;&gt;&amp;<sp/>matches)
{
<sp/><sp/><sp/>int<sp/>removed<sp/>=<sp/>0;
<sp/><sp/><sp/>//<sp/>for<sp/>all<sp/>matches
<sp/>for<sp/>(vector&lt;vector&lt;DMatch&gt;&gt;::iterator
<sp/><sp/><sp/><sp/><sp/><sp/>matchIterator
<sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>matches.begin();
<sp/><sp/><sp/><sp/><sp/>matchIterator<sp/>!=<sp/>matches.end();<sp/>++matchIterator)<sp/>{
<sp/><sp/><sp/><sp/><sp/>//<sp/>if<sp/>2<sp/>NN<sp/>has<sp/>been<sp/>identified
<sp/><sp/><sp/><sp/><sp/>if<sp/>(matchIterator-&gt;size()<sp/>&gt;<sp/>1)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>check<sp/>distance<sp/>ratio
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>((*matchIterator)[0].distance<sp/>/<sp/>(*matchIterator)[1].distance<sp/>&gt;<sp/>0.65f)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>matchIterator-&gt;clear();<sp/>//<sp/>remove<sp/>match
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>removed++;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>{<sp/>//<sp/>does<sp/>not<sp/>have<sp/>2<sp/>neighbors
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>matchIterator-&gt;clear();<sp/>//<sp/>remove<sp/>match
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>removed++;
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/>}
<sp/><sp/>return<sp/>removed;
}

/**<sp/>\brief<sp/>get<sp/>a<sp/>white<sp/>ring<sp/>mask<sp/>for<sp/>the<sp/>srcImg.
*<sp/>图像为一白色圆环，<sp/>图像大小与源图像相同，外径与内径在此设定
*<sp/>\param<sp/>cv::Size<sp/>size<sp/>源图大小
*<sp/>\param<sp/>outerRatio<sp/>外圆半径占比
*<sp/>\param<sp/>innerRatio<sp/>内圆半径占比
*<sp/>\param<sp/>ro<sp/>得到的外圆半径
*<sp/>\param<sp/>ri<sp/>得到的内圆半径
*/
cv::Mat<sp/>RobustMatcher::getMask(cv::Size<sp/>size,<sp/>double<sp/>outerRatio,<sp/>double<sp/>innerRatio,<sp/>int<sp/>&amp;ro,<sp/>int<sp/>&amp;ri)<sp/>const
{
<sp/><sp/><sp/>cv::Mat<sp/>mask<sp/>=<sp/>cv::Mat::zeros(size,<sp/>CV_8UC1);
<sp/><sp/>int<sp/>r<sp/>=<sp/>size.height<sp/>/<sp/>2;
<sp/><sp/><sp/>ro<sp/>=<sp/>r<sp/>*<sp/>outerRatio;
<sp/><sp/><sp/>ri<sp/>=<sp/>r<sp/>*<sp/>innerRatio;
<sp/><sp/><sp/>cv::circle(mask,<sp/>cv::Point(r,<sp/>r),<sp/>ro,<sp/>cv::Scalar(255),<sp/>-1,<sp/>8);
<sp/>//bitwise_not(mask1,<sp/>mask1);
<sp/><sp/><sp/>cv::circle(mask,<sp/>cv::Point(r,<sp/>r),<sp/>ri,<sp/>cv::Scalar(0),<sp/>-1,<sp/>8);
<sp/><sp/><sp/>return<sp/>mask;
}</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="67"><highlight class="normal"><sp/><sp/><sp/><sp/>drawMatches(src1,<sp/>keypoints1,<sp/>src2,<sp/>keypoints2,</highlight></codeline>
<codeline lineno="68"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>matches,<sp/>img_matches,<sp/>Scalar::all(-1),<sp/>Scalar::all(-1),</highlight></codeline>
<codeline lineno="69"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vector&lt;char&gt;(),<sp/>DrawMatchesFlags::NOT_DRAW_SINGLE_POINTS);</highlight></codeline>
<codeline lineno="70"><highlight class="normal"><sp/><sp/><sp/><sp/>circle(img_matches,<sp/>Point(mask1.cols<sp/>/<sp/>2,<sp/>mask1.rows<sp/>/<sp/>2),<sp/>ro1,<sp/>Scalar(0,<sp/>0,<sp/>255),<sp/>1,<sp/>LINE_AA);</highlight></codeline>
<codeline lineno="71"><highlight class="normal"><sp/><sp/><sp/><sp/>circle(img_matches,<sp/>Point(mask1.cols<sp/>/<sp/>2,<sp/>mask1.rows<sp/>/<sp/>2),<sp/>ri1,<sp/>Scalar(0,<sp/>255,<sp/>0),<sp/>1,<sp/>LINE_AA);</highlight></codeline>
<codeline lineno="72"><highlight class="normal"><sp/><sp/><sp/><sp/>circle(img_matches,<sp/>Point(mask1.cols<sp/>+<sp/>mask2.cols<sp/>/<sp/>2,<sp/>mask2.rows<sp/>/<sp/>2),<sp/>ro2,<sp/>Scalar(0,<sp/>0,<sp/>255),<sp/>1,<sp/>LINE_AA);</highlight></codeline>
<codeline lineno="73"><highlight class="normal"><sp/><sp/><sp/><sp/>circle(img_matches,<sp/>Point(mask1.cols<sp/>+<sp/>mask2.cols<sp/>/<sp/>2,<sp/>mask2.rows<sp/>/<sp/>2),<sp/>ri2,<sp/>Scalar(0,<sp/>255,<sp/>0),<sp/>1,<sp/>LINE_AA);</highlight></codeline>
<codeline lineno="74"><highlight class="normal"></highlight></codeline>
<codeline lineno="75"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>6.<sp/>求仿射变换</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="76"><highlight class="normal"><sp/><sp/><sp/><sp/>vector&lt;Point2f&gt;<sp/>obj;</highlight></codeline>
<codeline lineno="77"><highlight class="normal"><sp/><sp/><sp/><sp/>vector&lt;Point2f&gt;<sp/>scene;</highlight></codeline>
<codeline lineno="78"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>matches.size();<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="79"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//--<sp/>Get<sp/>the<sp/>keypoints<sp/>from<sp/>the<sp/>good<sp/>matches</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="80"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>obj.push_back(keypoints1[matches[i].queryIdx].pt);</highlight></codeline>
<codeline lineno="81"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>scene.push_back(keypoints2[matches[i].trainIdx].pt);</highlight></codeline>
<codeline lineno="82"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="83"><highlight class="normal"><sp/><sp/><sp/><sp/>Mat<sp/>M<sp/>=<sp/>estimateAffinePartial2D(obj,<sp/>scene);</highlight></codeline>
<codeline lineno="84"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(M.data<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="85"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="86"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//计算旋转角度，弧度 <sp/>auto<sp/>sin_alpha<sp/>=<sp/>M.at&lt;double&gt;(1,<sp/>0);<sp/>//<sp/>sin*s
<sp/><sp/>auto<sp/>cos_alpha<sp/>=<sp/>M.at&lt;double&gt;(0,<sp/>0);<sp/>//<sp/>cos*s
<sp/><sp/>angle<sp/>=<sp/>atan(sin_alpha<sp/>/<sp/>cos_alpha);<sp/>//<sp/>cv:顺时针为正
<sp/><sp/><sp/>return<sp/>true;
}

void<sp/>RobustMatcher::symmetryTest(const<sp/>vector&lt;vector&lt;DMatch&gt;&gt;&amp;<sp/>matches1,<sp/>const<sp/>vector&lt;vector&lt;DMatch&gt;&gt;&amp;<sp/>matches2,<sp/>vector&lt;DMatch&gt;&amp;<sp/>symMatches)
{
<sp/>//<sp/>for<sp/>all<sp/>matches<sp/>image<sp/>1<sp/>-&gt;<sp/>image<sp/>2
<sp/><sp/>for<sp/>(vector&lt;vector&lt;DMatch&gt;&gt;::
<sp/><sp/><sp/><sp/><sp/><sp/>const_iterator<sp/>matchIterator1
<sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>matches1.begin();
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>matchIterator1<sp/>!=<sp/>matches1.end();<sp/>++matchIterator1)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>ignore<sp/>deleted<sp/>matches
<sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(matchIterator1-&gt;size()<sp/>&lt;<sp/>2)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>continue;
<sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>for<sp/>all<sp/>matches<sp/>image<sp/>2<sp/>-&gt;<sp/>image<sp/>1
<sp/><sp/><sp/><sp/><sp/><sp/>for<sp/>(vector&lt;vector&lt;DMatch&gt;&gt;::
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const_iterator<sp/>matchIterator2
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>matches2.begin();
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>matchIterator2<sp/>!=<sp/>matches2.end();
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++matchIterator2)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>ignore<sp/>deleted<sp/>matches
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(matchIterator2-&gt;size()<sp/>&lt;<sp/>2)
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>continue;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>Match<sp/>symmetry<sp/>test
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>((*matchIterator1)[0].queryIdx<sp/>==<sp/>(*matchIterator2)[0].trainIdx<sp/>&amp;&amp;<sp/>(*matchIterator2)[0].queryIdx<sp/>==<sp/>(*matchIterator1)[0].trainIdx)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>add<sp/>symmetrical<sp/>match
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>symMatches.push_back(
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>DMatch((*matchIterator1)[0].queryIdx,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(*matchIterator1)[0].trainIdx,
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(*matchIterator1)[0].distance));
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>break;<sp/>//<sp/>next<sp/>match<sp/>in<sp/>image<sp/>1<sp/>-&gt;<sp/>image<sp/>2
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/>}
}

/**<sp/>\brief<sp/>kNN
<sp/>*<sp/>\param<sp/>matches<sp/>input<sp/>matches
<sp/>*<sp/>\return<sp/>the<sp/>removed<sp/>points<sp/>number
<sp/>*/
int<sp/>RobustMatcher::ratioTest(vector&lt;vector&lt;DMatch&gt;&gt;&amp;<sp/>matches)
{
<sp/><sp/><sp/>int<sp/>removed<sp/>=<sp/>0;
<sp/><sp/><sp/>//<sp/>for<sp/>all<sp/>matches
<sp/>for<sp/>(vector&lt;vector&lt;DMatch&gt;&gt;::iterator
<sp/><sp/><sp/><sp/><sp/><sp/>matchIterator
<sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>matches.begin();
<sp/><sp/><sp/><sp/><sp/>matchIterator<sp/>!=<sp/>matches.end();<sp/>++matchIterator)<sp/>{
<sp/><sp/><sp/><sp/><sp/>//<sp/>if<sp/>2<sp/>NN<sp/>has<sp/>been<sp/>identified
<sp/><sp/><sp/><sp/><sp/>if<sp/>(matchIterator-&gt;size()<sp/>&gt;<sp/>1)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>//<sp/>check<sp/>distance<sp/>ratio
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>((*matchIterator)[0].distance<sp/>/<sp/>(*matchIterator)[1].distance<sp/>&gt;<sp/>0.65f)<sp/>{
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>matchIterator-&gt;clear();<sp/>//<sp/>remove<sp/>match
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>removed++;
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>{<sp/>//<sp/>does<sp/>not<sp/>have<sp/>2<sp/>neighbors
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>matchIterator-&gt;clear();<sp/>//<sp/>remove<sp/>match
<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>removed++;
<sp/><sp/><sp/><sp/><sp/>}
<sp/><sp/>}
<sp/><sp/>return<sp/>removed;
}

/**<sp/>\brief<sp/>get<sp/>a<sp/>white<sp/>ring<sp/>mask<sp/>for<sp/>the<sp/>srcImg.
*<sp/>图像为一白色圆环，<sp/>图像大小与源图像相同，外径与内径在此设定
*<sp/>\param<sp/>cv::Size<sp/>size<sp/>源图大小
*<sp/>\param<sp/>outerRatio<sp/>外圆半径占比
*<sp/>\param<sp/>innerRatio<sp/>内圆半径占比
*<sp/>\param<sp/>ro<sp/>得到的外圆半径
*<sp/>\param<sp/>ri<sp/>得到的内圆半径
*/
cv::Mat<sp/>RobustMatcher::getMask(cv::Size<sp/>size,<sp/>double<sp/>outerRatio,<sp/>double<sp/>innerRatio,<sp/>int<sp/>&amp;ro,<sp/>int<sp/>&amp;ri)<sp/>const
{
<sp/><sp/><sp/>cv::Mat<sp/>mask<sp/>=<sp/>cv::Mat::zeros(size,<sp/>CV_8UC1);
<sp/><sp/>int<sp/>r<sp/>=<sp/>size.height<sp/>/<sp/>2;
<sp/><sp/><sp/>ro<sp/>=<sp/>r<sp/>*<sp/>outerRatio;
<sp/><sp/><sp/>ri<sp/>=<sp/>r<sp/>*<sp/>innerRatio;
<sp/><sp/><sp/>cv::circle(mask,<sp/>cv::Point(r,<sp/>r),<sp/>ro,<sp/>cv::Scalar(255),<sp/>-1,<sp/>8);
<sp/>//bitwise_not(mask1,<sp/>mask1);
<sp/><sp/><sp/>cv::circle(mask,<sp/>cv::Point(r,<sp/>r),<sp/>ri,<sp/>cv::Scalar(0),<sp/>-1,<sp/>8);
<sp/><sp/><sp/>return<sp/>mask;
}</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="87"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>sin_alpha<sp/>=<sp/>M.at&lt;</highlight><highlight class="keywordtype">double</highlight><highlight class="normal">&gt;(1,<sp/>0);<sp/></highlight><highlight class="comment">//<sp/>sin*s</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="88"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>cos_alpha<sp/>=<sp/>M.at&lt;</highlight><highlight class="keywordtype">double</highlight><highlight class="normal">&gt;(0,<sp/>0);<sp/></highlight><highlight class="comment">//<sp/>cos*s</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="89"><highlight class="normal"><sp/><sp/><sp/><sp/>angle<sp/>=<sp/>atan(sin_alpha<sp/>/<sp/>cos_alpha);<sp/></highlight><highlight class="comment">//<sp/>cv:顺时针为正</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="90"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="91"><highlight class="normal">}</highlight></codeline>
<codeline lineno="92"><highlight class="normal"></highlight></codeline>
<codeline lineno="93"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>RobustMatcher::symmetryTest(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>vector&lt;vector&lt;DMatch&gt;&gt;&amp;<sp/>matches1,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>vector&lt;vector&lt;DMatch&gt;&gt;&amp;<sp/>matches2,<sp/>vector&lt;DMatch&gt;&amp;<sp/>symMatches)</highlight></codeline>
<codeline lineno="94"><highlight class="normal">{</highlight></codeline>
<codeline lineno="95"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>for<sp/>all<sp/>matches<sp/>image<sp/>1<sp/>-&gt;<sp/>image<sp/>2</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="96"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(vector&lt;vector&lt;DMatch&gt;&gt;::</highlight></codeline>
<codeline lineno="97"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const_iterator<sp/>matchIterator1</highlight></codeline>
<codeline lineno="98"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>matches1.begin();</highlight></codeline>
<codeline lineno="99"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>matchIterator1<sp/>!=<sp/>matches1.end();<sp/>++matchIterator1)<sp/>{</highlight></codeline>
<codeline lineno="100"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>ignore<sp/>deleted<sp/>matches</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="101"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(matchIterator1-&gt;size()<sp/>&lt;<sp/>2)</highlight></codeline>
<codeline lineno="102"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="103"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>for<sp/>all<sp/>matches<sp/>image<sp/>2<sp/>-&gt;<sp/>image<sp/>1</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="104"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(vector&lt;vector&lt;DMatch&gt;&gt;::</highlight></codeline>
<codeline lineno="105"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const_iterator<sp/>matchIterator2</highlight></codeline>
<codeline lineno="106"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>matches2.begin();</highlight></codeline>
<codeline lineno="107"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>matchIterator2<sp/>!=<sp/>matches2.end();</highlight></codeline>
<codeline lineno="108"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++matchIterator2)<sp/>{</highlight></codeline>
<codeline lineno="109"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>ignore<sp/>deleted<sp/>matches</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="110"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(matchIterator2-&gt;size()<sp/>&lt;<sp/>2)</highlight></codeline>
<codeline lineno="111"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="112"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Match<sp/>symmetry<sp/>test</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="113"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((*matchIterator1)[0].queryIdx<sp/>==<sp/>(*matchIterator2)[0].trainIdx<sp/>&amp;&amp;<sp/>(*matchIterator2)[0].queryIdx<sp/>==<sp/>(*matchIterator1)[0].trainIdx)<sp/>{</highlight></codeline>
<codeline lineno="114"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>add<sp/>symmetrical<sp/>match</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="115"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>symMatches.push_back(</highlight></codeline>
<codeline lineno="116"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>DMatch((*matchIterator1)[0].queryIdx,</highlight></codeline>
<codeline lineno="117"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(*matchIterator1)[0].trainIdx,</highlight></codeline>
<codeline lineno="118"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(*matchIterator1)[0].distance));</highlight></codeline>
<codeline lineno="119"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>next<sp/>match<sp/>in<sp/>image<sp/>1<sp/>-&gt;<sp/>image<sp/>2</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="121"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="122"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="123"><highlight class="normal">}</highlight></codeline>
<codeline lineno="124"><highlight class="normal"></highlight></codeline>
<codeline lineno="129"><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>RobustMatcher::ratioTest(vector&lt;vector&lt;DMatch&gt;&gt;&amp;<sp/>matches)</highlight></codeline>
<codeline lineno="130"><highlight class="normal">{</highlight></codeline>
<codeline lineno="131"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>removed<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="132"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>for<sp/>all<sp/>matches</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="133"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(vector&lt;vector&lt;DMatch&gt;&gt;::iterator</highlight></codeline>
<codeline lineno="134"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>matchIterator</highlight></codeline>
<codeline lineno="135"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>matches.begin();</highlight></codeline>
<codeline lineno="136"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>matchIterator<sp/>!=<sp/>matches.end();<sp/>++matchIterator)<sp/>{</highlight></codeline>
<codeline lineno="137"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>2<sp/>NN<sp/>has<sp/>been<sp/>identified</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="138"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(matchIterator-&gt;size()<sp/>&gt;<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="139"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>check<sp/>distance<sp/>ratio</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="140"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((*matchIterator)[0].distance<sp/>/<sp/>(*matchIterator)[1].distance<sp/>&gt;<sp/>0.65f)<sp/>{</highlight></codeline>
<codeline lineno="141"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>matchIterator-&gt;clear();<sp/></highlight><highlight class="comment">//<sp/>remove<sp/>match</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="142"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>removed++;</highlight></codeline>
<codeline lineno="143"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="144"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="145"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{<sp/></highlight><highlight class="comment">//<sp/>does<sp/>not<sp/>have<sp/>2<sp/>neighbors</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="146"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>matchIterator-&gt;clear();<sp/></highlight><highlight class="comment">//<sp/>remove<sp/>match</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="147"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>removed++;</highlight></codeline>
<codeline lineno="148"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="149"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="150"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>removed;</highlight></codeline>
<codeline lineno="151"><highlight class="normal">}</highlight></codeline>
<codeline lineno="152"><highlight class="normal"></highlight></codeline>
<codeline lineno="161"><highlight class="normal">cv::Mat<sp/>RobustMatcher::getMask(cv::Size<sp/>size,<sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>outerRatio,<sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>innerRatio,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>&amp;ro,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>&amp;ri)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="162"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="163"><highlight class="normal"><sp/><sp/><sp/><sp/>cv::Mat<sp/>mask<sp/>=<sp/>cv::Mat::zeros(size,<sp/>CV_8UC1);</highlight></codeline>
<codeline lineno="164"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>r<sp/>=<sp/>size.height<sp/>/<sp/>2;</highlight></codeline>
<codeline lineno="165"><highlight class="normal"><sp/><sp/><sp/><sp/>ro<sp/>=<sp/>r<sp/>*<sp/>outerRatio;</highlight></codeline>
<codeline lineno="166"><highlight class="normal"><sp/><sp/><sp/><sp/>ri<sp/>=<sp/>r<sp/>*<sp/>innerRatio;</highlight></codeline>
<codeline lineno="167"><highlight class="normal"><sp/><sp/><sp/><sp/>cv::circle(mask,<sp/>cv::Point(r,<sp/>r),<sp/>ro,<sp/>cv::Scalar(255),<sp/>-1,<sp/>8);</highlight></codeline>
<codeline lineno="168"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//bitwise_not(mask1,<sp/>mask1);</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="169"><highlight class="normal"><sp/><sp/><sp/><sp/>cv::circle(mask,<sp/>cv::Point(r,<sp/>r),<sp/>ri,<sp/>cv::Scalar(0),<sp/>-1,<sp/>8);</highlight></codeline>
<codeline lineno="170"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>mask;</highlight></codeline>
<codeline lineno="171"><highlight class="normal">}</highlight></codeline>
    </programlisting>
    <location file="sources/robustmatcher.cpp"/>
  </compounddef>
</doxygen>
